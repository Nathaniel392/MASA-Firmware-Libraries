"""
MASA pressure transducer calibration generator script

Michigan Aeronautical Science Association
Author: Leif Gullstad (leifg@umich.edu)
Created: December 20, 2020 
Updated: December 21, 2020

REQUIRES: csv contains columns labeled offset and slope
            script does not care about the location nor order they appear in
"""
import time
import sys
import csv

# Used to split() lines into columns
COLUMN_DELIMITER = ','
# File name hard coded. Should probably change to command line arg
INPUT_FILE_NAME = 'pt_calibration.csv'


def main():
    # Autogeneration label and timestamp
    begin_autogen_tag = "/// BEGIN AUTOGENERATED SECTION - MODIFICATIONS TO THIS CODE WILL BE OVERWRITTEN\n"
    end_autogen_tag = "/// END AUTOGENERATED SECTION - USER CODE GOES BELOW THIS LINE\n"
    autogen_label = "/// Autogenerated by pt_calibration_generator.py on " + time.ctime()

    # Don't think I need to create a globals file
    # If globals needed, generate here

    # Strings to hold what I want printed into the file
    pack_pt_calibration_h_str = ""

    pack_pt_calibration_h_str += begin_autogen_tag + "\n/// pack_pt_calibration.h\n" + autogen_label + "\n\n"

    channel_num = -1
    # Holds values for slope and offset
    calibration_h_slope = ""
    calibration_h_offset = ""
    slope_col = 0
    offset_col = 0
    # Iterate through csv file storing values of slopes and offsets
    more_than_zero_lines = False
    with open(INPUT_FILE_NAME) as csvfile:
        data_iter = csv.reader(csvfile, delimiter=COLUMN_DELIMITER)
        for row in data_iter:
            if channel_num > 0:
                more_than_zero_lines = True
                calibration_h_slope += ", "
                calibration_h_offset += ", "
                # New line every 5 numbers for readability
                if channel_num % 5 == 0:
                    calibration_h_slope += "\n\t\t\t\t\t"
                    calibration_h_offset += "\n\t\t\t\t\t"
            if channel_num != -1:  # Skips first row with column titles
                # Defaulting slope to 1 and offset to 0 if no value is given
                if str(row[slope_col]) == "":
                    slope = 1
                else:
                    slope = row[slope_col]
                if str(row[offset_col]) == "":
                    offset = 0
                else:
                    offset = row[offset_col]

                calibration_h_slope += str(slope)
                calibration_h_offset += str(offset)
            # For loop below finds which column the slope and offset data are in
            else:  # Implies that channel_num == -1
                index = 0
                for col in row:
                    if col == "slope":
                        slope_col = index
                    elif col == "offset":
                        offset_col = index
                    index += 1

            channel_num += 1

    calibration_h_slope += "};\n\n"
    calibration_h_offset += "};"
    slope_declaration = "double pt_slope[" + str(channel_num) + "] = {"
    offset_declaration = "double pt_offset[" + str(channel_num) + "] = {"

    # Print file strings to files
    pack_pt_calibration_h = open("../inc/pack_pt_calibration.h", "w+")
    if more_than_zero_lines:
        pack_pt_calibration_h.write(pack_pt_calibration_h_str + slope_declaration + \
                                    calibration_h_slope + offset_declaration + calibration_h_offset)
    else:
        print("Error: No data in csv file")
        pack_pt_calibration_h.write("Error: No data in csv file")


if __name__ == '__main__':
    main()
